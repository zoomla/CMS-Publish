@model System.Data.DataTable
@{ 
    Layout = "_empty";
}
@section head{
<title>@L.数据排序</title>
<style type="text/css">
.thead span{font-weight:bolder;}
.list-group-item {padding:0px;display:flex;cursor:pointer;}
.list-group-item.active{background-color:#95d2fe;color:#fff;}
.order_t{width:100%;text-align:center;}
.list-group-item span{box-sizing: border-box; border-right:1px solid #ddd; padding:5px 8px;}
.w5{width:5%;min-width:50px;}
.w10{width:10%;min-width:50px;}
.w50{width:50%;min-width:250px;}
.w30{width:30%;min-width:200px;}
.w15{width:15%;min-width:100px;}
.sortable-ghost{background-color:#95d2fe;color:#fff;}
/*.sortable-chosen{background-color:#95d2fe;color:#fff;}*/
/*.sortable-drag{display:none;}*/
</style>
}
@section content{
    <div class="list-group" style="margin-bottom: 5px;">
        <div class="list-group-item thead">
            <span class="w10 text-center">@L.操作</span>
            <span class="w5">@L.序号</span>
            <span class="w5">ID</span>
            <span class="w50">@L.标题<b class="text-danger">(@L.支持拖动排序)</b></span>
            <span class="w30">@L.备注</span>
        </div>
    </div>
    <div id="items_wrap" class="list-group">
       @foreach(DataRow dr in Model.Rows)
        {
        <div class="list-group-item order_tr" data-id="@dr["id"]" data-oid="@dr["order"]">
            <span class="w10 text-center">
                <button type="button" class="btn btn-info btn-sm" onclick="sort.up(this);"><i class="zi zi_forUp"></i></button>
                <button type="button" class="btn btn-info btn-sm" onclick="sort.down(this);"><i class="zi zi_forDown"></i></button>
            </span>
            <span class="w5">
                <input type="text" value="@dr["order"]" class="order_t" disabled="disabled"/>
            </span>
            <span class="w5"> @dr["id"]</span>
            <span class="w50">@dr["title"]</span>
            <span class="w30">@dr["remind"]</span>
        </div>
        }
    </div>
    <div style="height: 60px;"></div>
    <div style="position: fixed; text-align: center; padding: 5px 8px; background: rgba(0, 0, 0, 0.46); bottom: 5px; left: 0px; width: 100%; z-index: 10;border-radius:5px;">
        <button type="button" class="btn btn-info" onclick="sort.reorder();">@L.重新生成序号</button>
        <button type="button" class="btn btn-info" onclick="sort.save();">@L.保存排序</button>
    </div>

}
@section script{
<script src="/JS/Plugs/Sortable.js"></script>
<script>
    // List with handle
    var sortTable = Sortable.create(document.getElementById("items_wrap"), {
        //handle: '.zi_ydjt',
        filter: ".ignore",  // Selectors that do not lead to dragging (String or Function)
        animation: 0,
        dataIdAttr: 'data-id',
        onStart: function (evt) {
            $(".list-group-item").removeClass("active");
        },
        onEnd: function (evt) {
            $(evt.item).addClass("active");
        },
    });
    //用于table布局下排序
    var sort = {};
    sort.orgin = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));
    sort.up = function (dom) {
        var $item = $(dom).closest(".list-group-item");
        if (!$item.hasClass("active")) {
            $(".list-group-item").removeClass("active");
            $item.addClass("active");
        }
        //1.直接交换位置,是否会造成排序不正常
        var $pre = $item.prev(".list-group-item");
        if ($pre.length > 0) {
            $pre.before($item);
        }
    }
    sort.down = function (dom) {
        var $item = $(dom).closest(".list-group-item");
        if (!$item.hasClass("active")) {
            $(".list-group-item").removeClass("active");
            $item.addClass("active");
        }
        //1.直接交换位置,是否会造成排序不正常
        var $next = $item.next(".list-group-item");
        if ($next.length > 0) {
            $next.after($item);
        }
    }
    sort.save=function(){
        //导出排序后的orderid数组
        var array=sortTable.toArray();
        var orderStr="";
        for (var i = 0; i < array.length; i++) {
            orderStr+=array[i]+":"+sort.orgin[i].order+",";
        }
        $.post("Sort_API?action=save&tbname=@(ViewBag.TbName)",{"orderStr":orderStr},function(data){
             alert("@Html.Raw(L.排序保存成功)");
            if(parent.sort_callback){parent.sort_callback();}
        })
    }
    //重新从1开始生成序列号(根据tr顺序)
    sort.reorder = function () {
        if(!confirm("@Html.Raw(L.确定重申序号吗)")){return false;}
        var orderStr="";
        var $trs = $(".order_tr");
        for (var i = 0; i < $trs.length; i++) {
            var id=$($trs[i]).data("id");
            var oid=(i+1);
            //$($trs[i]).data("oid",oid);
            //$($trs[i]).find(".order_t").val(oid);
            orderStr+=id+":"+oid+",";
        }
        $.post("Sort_API?action=save&tbname=@(ViewBag.TbName)",{"orderStr":orderStr},function(data){
            location=location;
        })
    }
</script>
}