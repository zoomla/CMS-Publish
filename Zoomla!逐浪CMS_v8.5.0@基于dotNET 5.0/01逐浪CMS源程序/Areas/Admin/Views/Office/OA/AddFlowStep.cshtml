@functions{
    //B_User buser = new B_User();
    //        B_Structure strBll = new B_Structure();
    //        M_MisProcedure proMod = new M_MisProcedure();
    //        B_MisProcedure proBll = new B_MisProcedure();
    //        B_MisProLevel stepBll = new B_MisProLevel();
    //        //流程ID
    //        public int proID { get { return DataConvert.CLng(Request.QueryString["ProID"]); } }
    //        public int Mid { get { return DataConvert.CLng(Request.QueryString["StepID"]); } }
    //        protected void Page_Load(object sender, EventArgs e)
    //        {
    //            if (proID < 1) {function.WriteErrMsg("请先选定流程!!!"); }
    //            if (!IsPostBack)
    //            {
    //                ParentID_DP.DataSource = stepBll.SelByProID(proID);
    //                ParentID_DP.DataBind();
    //                ParentID_DP.Items.Insert(0, new ListItem("主线流程", "0"));
    //                if (Mid > 0)
    //                {
    //                    saveBtn.Text = "修改步骤";
    //                    M_MisProLevel stepMod = stepBll.SelReturnModel(Mid);
    //                    stepCodeT.Text = stepMod.stepNum.ToString();
    //                    stepNameT.Text = stepMod.stepName;
    //                    //------------------主办,协议信息
    //                    ReferUser_Alias_T.Text = stepMod.ReferUser_Alias;
    //                    ReferUser_Hid.Value = stepMod.ReferUser;
    //                    referUserDatas_Hid.Value = JsonConvert.SerializeObject(buser.SelectUserByIds(stepMod.ReferUser));
    //                    ReferUser_T.Text = buser.GetUserNameByIDS(stepMod.ReferUser);
    //                    //referGroup_Hid.Value = stepMod.ReferGroup;
    //                    CCUser_Alias_T.Text = stepMod.CCUser_Alias;
    //                    CCUser_Allow_Chk.Checked = stepMod.CCUser_Allow == 1;
    //                    CCUser_Hid.Value = stepMod.CCUser;
    //                    ccUserDatas_Hid.Value = JsonConvert.SerializeObject(buser.SelectUserByIds(stepMod.CCUser));
    //                    CCUser_T.Text = buser.GetUserNameByIDS(stepMod.CCUser);
    //                    CCUser_HQ.Checked=stepMod.StepAuth.CCUser_HQ;
    //                    HelpUser_Alias_T.Text = stepMod.HelpUser_Alias;
    //                    HelpUser_Allow_Chk.Checked = stepMod.HelpUser_Allow == 1;

    //                    emailAlertD.Value = stepMod.EmailAlert;
    //                    emailGroupD.Value = stepMod.EmailGroup;
    //                    smsAlertD.Value = stepMod.SmsAlert;
    //                    smsGroupD.Value = stepMod.SmsGroup;
    //                    emailAlertT.Text = buser.GetUserNameByIDS(stepMod.EmailAlert);
    //                    emailGroupT.Text = strBll.SelStrNameByIDS(stepMod.EmailGroup);
    //                    smsAlertT.Text = buser.GetUserNameByIDS(stepMod.SmsAlert);
    //                    smsGroupT.Text = strBll.SelStrNameByIDS(stepMod.SmsGroup);
    //                    hqOptionDP.SelectedValue = stepMod.HQoption.ToString();
    //                    qzzjDP.SelectedValue = stepMod.Qzzjoption.ToString();
    //                    htDP.SelectedValue = stepMod.HToption.ToString();
    //                    remindT.Text = stepMod.Remind;


    //                    RUser_ManageAttach.Checked = stepMod.StepAuth.RUser_ManageAttach;
    //                    RUser_ChangeUser.Checked = stepMod.StepAuth.RUser_ChangeUser;
    //                    CCUser_Write.Checked = stepMod.StepAuth.CCUser_Write;
    //                    HUser_Write.Checked = stepMod.StepAuth.HUser_Write;
    //                    ParentID_DP.SelectedValue = stepMod.ParentID.ToString();

    //                    function.Script(this, "SetRadVal('next_rad','" + stepMod.DocAuth + "');");
    //                    function.Script(this, "SetChkVal('nextop_chk','" + stepMod.NextOP + "');");
    //                }
    //                Call.SetBreadCrumb(Master, "<li><a href='" + CustomerPageAction.customPath2 + "Main.aspx'>工作台</a></li><li><a href='../Config/SiteOption.aspx'>系统设置</a></li><li><a href='AddFlow.aspx?proID=" + proID + "'>流程设计</a></li><li class='active'>添加步骤</a></li>");
    //            }
    //        }
    //        /// <summary>
    //        /// 产生序号
    //        /// </summary>
    //        /// <param name="pid">目标流程的ID</param>
    //        /// <returns></returns>
    //        private int GenStepNum(int proid, int parentid)
    //        {
    //            int stepNum = DataConvert.CLng(DBCenter.ExecuteScala("ZL_MisProLevel", "MAX(StepNum)", "ProID=" + proid + " AND ParentID=" + parentid));
    //            return (stepNum + 1);
    //        }
    //        protected void saveBtn_Click(object sender, EventArgs e)
    //        {
    //            M_MisProLevel stepMod = new M_MisProLevel();
    //            if (Mid > 0) { stepMod = stepBll.SelReturnModel(Mid); }
    //            stepMod.stepName = stepNameT.Text.Trim();
    //            //stepModel.CCGroup = StrHelper.PureIDSForDB(ccGroup_Hid.Value);
    //            stepMod.HQoption = DataConvert.CLng(hqOptionDP.SelectedValue);
    //            stepMod.Qzzjoption = DataConvert.CLng(qzzjDP.SelectedValue);
    //            stepMod.HToption = DataConvert.CLng(htDP.SelectedValue);
    //            stepMod.EmailAlert = emailAlertD.Value.TrimEnd(',');
    //            stepMod.EmailGroup = emailGroupD.Value.TrimEnd(',');
    //            stepMod.SmsAlert = smsAlertD.Value.TrimEnd(',');
    //            stepMod.SmsGroup = smsGroupD.Value.TrimEnd(',');
    //            stepMod.Remind = remindT.Text.Trim();
    //            stepMod.DocAuth = Request.Form["next_rad"];
    //            stepMod.NextOP = Request.Form["nextop_chk"];
    //            stepMod.ParentID = Convert.ToInt32(ParentID_DP.SelectedValue);


    //            //主办协办等配置
    //            stepMod.ReferUser = StrHelper.PureIDSForDB(ReferUser_Hid.Value);
    //            stepMod.CCUser = StrHelper.PureIDSForDB(CCUser_Hid.Value);
    //            stepMod.ReferUser_Alias = ReferUser_Alias_T.Text;
    //            stepMod.CCUser_Alias = CCUser_Alias_T.Text;
    //            stepMod.CCUser_Allow = CCUser_Allow_Chk.Checked ? 1 : 0;
    //            stepMod.HelpUser_Alias = HelpUser_Alias_T.Text;
    //            stepMod.HelpUser_Allow = HelpUser_Allow_Chk.Checked ? 1 : 0;
    //            stepMod.StepAuth.RUser_ManageAttach = RUser_ManageAttach.Checked;
    //            stepMod.StepAuth.RUser_ChangeUser = RUser_ChangeUser.Checked;
    //            stepMod.StepAuth.CCUser_Write = CCUser_Write.Checked;
    //            stepMod.StepAuth.CCUser_HQ = CCUser_HQ.Checked;
    //            stepMod.StepAuth.HUser_Write = HUser_Write.Checked;
    //            if (stepMod.ID > 0)
    //            {
    //                stepBll.UpdateByID(stepMod);
    //            }
    //            else
    //            {
    //                //步骤序号只在列表页可更改
    //                stepMod.ProID = DataConvert.CLng(proID);
    //                stepMod.stepNum = GenStepNum(stepMod.ProID, stepMod.ParentID);
    //                stepBll.insert(stepMod);
    //            }
    //            function.WriteSuccessMsg("操作成功", "AddFlow.aspx?proID=" + stepMod.ProID);
    //        }


}
@{
//B_MisProLevel stepBll = new B_MisProLevel();
//M_MisProcedure proMod = new M_MisProcedure();
//if (string.IsNullOrEmpty(ViewBag.stepID)) { proMod = stepBll.SelReturnModel(ViewBag.stepID); }
//if (proMod == null) { proMod = new M_MisProcedure(); }
}
@section head{<title>流程设计</title> }
@section content{
    @Call.SetBread(new Bread[] {
        new Bread("{admin}"),
        new Bread("/{manage}/Config/SiteInfo.aspx","系统设置"),
        new Bread("AddFlow.aspx?proID=","流程设计"),
        new Bread() {url="", text="添加步骤",addon="" }}
        )
    <div id="Addstep" class="container-fluid pe-0" runat="server">
        <div class="row sysRow">
            <form method="post" action="@MVCHelper.GetAction("AddFlowStep_Submit",Context.Request)">
                <table class="table table-striped table-bordered table-hover sys_table">
                    <tr>
                        <th class="w12rem_lg">序号</th>
                        <td>
                            @*@Html.TextBox("stepCodeT", "" , new { @class = "form-control",@style = "Width:50px", @disabled = "disabled" })*@
                            <input type="text" Class="form-control" ID="stepCodeT" disabled="disabled" name="stepCodeT" style="Width:50px" value="@Model.ID" />
                            @*<asp:TextBox runat="server" CssClass="form-control" ID="stepCodeT" Enabled="false" Width="40" />*@
                        </td>
                    </tr>
                    <tr>
                        <th>步骤名称 <span class="text-danger">*</span></th>
                        <td>
                            <input type="text" Class="form-control max20rem" ID="stepNameT" name="stepNameT" value="@Model.stepName"/>
                        </td>
                    </tr>
                    <tr>
                        <th>步骤简述</th>
                        <td>
                            <input type="text" Class="form-control max20rem" ID="remindT" name="remindT" value="@Model.Remind"/>
                        </td>
                    </tr>
                    <tr>
                        <th>所属步骤</th>
                        <td>
                            <select ID="ParentID" name="ParentID_DP" class="form-control max20rem">
                                <option value="0">主线流程</option>
                                @{
                                    B_MisProLevel stepBll = new B_MisProLevel();
                                    DataTable dt = stepBll.SelByProID(ViewBag.proMod.ID);
                                    foreach (DataRow dr in dt.Rows)
                                    {
                                        <option value="@dr["ID"]">@dr["StepName"]</option>
                                    }
                                }
                            </select>
                            <small class="text-muted">提示:指定所属父步骤,用于创建分支流程</small>
                        </td>
                    </tr>
                    <tr>
                        <th>主办人</th>
                        <td>
                            <div>
                                <input type="text" Class="form-control max20rem" ID="ReferUser_Alias_T" name="ReferUser_Alias_T" placeholder="主办名称" value="主办人" />
                                <input type="checkbox" ID="RUser_ChangeUser" name="RUser_ChangeUser" value="1" /><label for="RUser_ChangeUser">更改协辅办(流程中，主办人可更改协办与辅办人员)</label>
                                <input type="checkbox" ID="RUser_ManageAttach" name="RUser_ManageAttach" value="1" /><label for="RUser_ManageAttach">主办人可管理附件</label>
                            </div>
                            <div class="input-group max20rem" style="display:none;">
                                <input type="text" Class="form-control" ID="ReferUser_T" name="ReferUser_T" />
                                <span class="input-group-btn">
                                    <input type="button" value="选择" onclick="selRuser();" class="btn btn-info" />
                                </span>
                            </div>
                            <input type="hidden" id="ReferUser_Hid" name="ReferUser_Hid" />
                            @*<asp:HiddenField runat="server" ID="ReferUser_Hid" />*@
                        </td>
                    </tr>
                    <tr>
                        <th>协办人<br />(可查看与批复)</th>
                        <td>
                            <div>
                                <input type="text" Class="form-control max20rem" ID="CCUser_Alias_T" name="CCUser_Alias_T" placeholder="协办名称" value="协办人" />
                                <input type="checkbox" ID="CCUser_Allow_Chk" name="CCUser_Allow_Chk" value="1" Checked="checked" /><label for="CCUser_Allow_Chk">允许协办</label>
                                <input type="checkbox" ID="CCUser_Write" name="CCUser_Write" value="1" Checked="checked" /><label for="CCUser_Write">协办允许批复</label>
                                <input type="checkbox" ID="CCUser_HQ" name="CCUser_HQ" value="1" /><label for="CCUser_HQ">协办会签(协办必须完成会签才能进入下一步)</label>
                            </div>
                            <div style="display:none;">
                                <div class="input-group max20rem">
                                    <input type="text" Class="form-control" ID="CCUser_T" name="CCUser_T" />
                                    <span class="input-group-btn">
                                        <input type="button" value="选择" onclick="selCUser();" class="btn btn-info" />
                                    </span>
                                </div>
                                <input type="hidden" Class="form-control" ID="CCUser_Hid" name="CCUser_Hid" />
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>辅办人<br />(权限同于协办)</th>
                        <td>
                            <div>
                                <input type="text" Class="form-control max20rem" ID="HelpUser_Alias_T" name="HelpUser_Alias_T" placeholder="辅办名称,无则为辅办人" value="@Model.HelpUser_Alias"/>
                                <input type="checkbox" ID="HelpUser_Allow_Chk" name="HelpUser_Allow_Chk" value="1" /><label for="HelpUser_Allow_Chk">允许辅办</label>
                                <input type="checkbox" ID="HUser_Write" name="HUser_Write" value="1" /><label for="HUser_Write">辅办允许批复</label>

                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>会签选项</th>
                        <td>
                            <select Class="form-control max20rem" ID="hqOptionDP" name="hqOptionDP">
                                <option Value="0">任意一人即可</option>
                                <option Value="1" Selected="selected">必须全部审核</option>
                            </select>
                            <small class="text-muted">提示:选择必须全部审核,则需要所有经办人审核并同意,才能进入下一步骤</small>
                        </td>
                    </tr>
                    <tr>
                        <th>转交</th>
                        <td>
                            <select Class="form-control max20rem" ID="qzzjDP" name="qzzjDP">
                                <option Value="1">允许</option>
                                <option Value="0" Selected="selected">不允许</option>
                            </select>
                            <small class="text-muted">提示:经办人未办理完毕时是否允发起人强制转交</small>
                        </td>
                    </tr>
                    <tr>
                        <th>是否允许回退</th>
                        <td>
                            <select Class="form-control max20rem" ID="htDP" name="htDP">
                                <option Value="0">不允许</option>
                                <option Value="1">允许回退上一步骤</option>
                                <option Value="2">允许回退之前步骤</option>
                            </select>
                        </td>
                    </tr>
                    <tr style="display:none">
                        <th>转交时,邮件自动通知以下人员</th>
                        <td>
                            <div class="mb-3">
                                <span class="float-start text-end">会员：</span>
                                <div class="input-group max20rem">
                                    <input type="text" Class="form-control" ID="emailAlertT" name="emailAlertT" />
                                    <span class="input-group-btn">
                                        <input type="button" id="emailSelBtn" value="选择" class="btn btn-primary" onclick="showdiv('div_share', 'emailAlert');" />
                                    </span>
                                </div>
                                <input type="hidden" ID="emailAlertD" />
                            </div>
                            <div>
                                <span class="float-start text-end">会员组：</span>
                                <div class="input-group max20rem">
                                    <input type="text" Class="form-control" ID="emailGroupT" name="emailGroupT" />
                                    <span class="input-group-btn">
                                        <input type="button" id="Button3" value="选择" class="btn btn-primary" onclick="showdiv('div_group', 'emailGroup');" />
                                    </span>
                                </div>
                                <input type="hidden" ID="emailGroupD" />
                            </div>
                        </td>
                    </tr>
                    <tr style="display:none">
                        <th>转交时,短信通知以下人员</th>
                        <td>
                            <div class="mb-3">
                                <span class="float-start text-end">会员：</span>
                                <div class="input-group max20rem">
                                    <input type="text" Class="form-control" ID="smsAlertT" name="smsAlertT" />
                                    <span class="input-group-btn">
                                        <input type="button" id="smsSelBtn" value="选择" class="btn btn-primary" onclick="showdiv('div_share', 'smsAlert');" />
                                    </span>
                                </div>
                                <input type="hidden" ID="smsAlertD" />
                            </div>
                            <div>
                                <span class="float-start text-end">会员组：</span>
                                <div class="input-group max20rem">
                                    <input type="text" Class="form-control" ID="smsGroupT" name="smsGroupT" />
                                    <span class="input-group-btn">
                                        <input type="button" id="Button4" value="选择" class="btn btn-primary" onclick="showdiv('div_group', 'smsGroup');" />
                                    </span>
                                </div>
                                <input type="hidden" ID="smsGroupD" />
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>步骤完成后,下一步权限</th>
                        <td>
                            <label><input type="radio" name="next_rad" value="refer" />主办人</label>
                            <label><input type="radio" name="next_rad" value="sender" />发起人</label>
                            <label><input type="radio" name="next_rad" value="all" checked="checked" />主办人和发起人</label>
                        </td>
                    </tr>
                    <tr>
                        <th>步骤完成后,下一步可操作</th>
                        <td>
                            <label><input type="checkbox" name="nextop_chk" value="文件归档" />文件归档</label>
                            <label><input type="checkbox" name="nextop_chk" value="文件传阅" />文件传阅</label>
                            @*<%--        <label><input type="checkbox" name="nextop_chk" value="文件呈阅" />文件呈阅</label>--%>*@
                        </td>
                    </tr>
                    @*<%--
                        <tr>
                            <th>公共附件选项</th>
                            <td>
                                <asp:DropDownList runat="server" ID="PublicAttachOptionDP" CssClass="form-control text_md">
                                    <asp:ListItem Value="0">不允许附件</asp:ListItem>
                                    <asp:ListItem Value="1" Selected="True">允许附件</asp:ListItem>
                                </asp:DropDownList>
                            </td>
                        </tr>--%>*@
                    <tr>
                        <th>操作</th>
                        <td>
                            <input type="submit" value="保存步骤" OnClick="return saveBtn_Click();" Class="btn btn-info" id="saveBtn" />
                            <a href="AddFlow.aspx?proID=<%:proID %>" class="btn btn-outline-info">返回列表</a>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
    <input type="hidden" ID="referUserDatas_Hid" name="referUserDatas_Hid" />
    <input type="hidden" ID="ccUserDatas_Hid" name="ccUserDatas_Hid" />

}
@section script{
    <script src="/JS/SelectCheckBox.js"></script>
    <script src="/JS/Controls/ZL_Array.js"></script>
    <script src="/JS/Plugs/angular.min.js"></script>
    <script>
        //user.hook["ReferUser"] = userdeal;
        //user.hook["CCUser"] = userdeal;
        //function userdeal(list, select) {
        //    var names ="" ,ids="";
        //    for(var i =0;i<list.length;i++){
        //        names += list[i].UserName + ",";
        //        ids += list[i].UserID + ",";
        //    }
        //    $("#" + select + "_T").val(names);
        //    $("#" + select + "_Hid").val(ids);
        //    if (comdiag != null) { CloseComDiag(); }
        //}
        function selRuser() {
            ShowComDiag("/Common/Dialog/SelStructure.aspx?Type=AllInfo#ReferUser", "选择主办人");
        }
        function selCUser() {
            ShowComDiag("/Common/Dialog/SelStructure.aspx?Type=AllInfo#CCUser", "选择协办人");
        }
        function UserFunc(json, select) {
            return user.deal_def(json, select);
        }

    </script>
}
