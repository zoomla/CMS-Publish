@model ZoomLa.Model.Other.M_WX_MsgTlp

@section head{ 
<title>@L.多图文消息</title>
<script type="text/javascript" charset="utf-8" src="/Plugins/Ueditor/ueditor.config.js"></script>
<script type="text/javascript" charset="utf-8" src="/Plugins/Ueditor/ueditor.all.js"></script>
}
@section content{
@Call.SetBread(new Bread[] {
		new Bread("{admin}"),
        new Bread("MsgTlp",L.消息列表),
        new Bread() {url=Context.Request.RawUrl(), text=L.多图文消息,addon="" }}
		)
<form method="post" action="@MVCHelper.GetAction("MsgMultiAdd_Submit",Context.Request)">
	<div class="container-fluid">
	<div class=" row">
    <div class="appmsg multi col-12 col-md-3">
        <div class="msgthumb msgitemf" data-id="default"  onclick="editItem(this);" title="点击编辑" style="cursor:pointer;">
            <img src="/UploadFiles/nopic.gif" class="headimg" id="topimg"/>
            <div class="msgthumb_foot">
                <div class="title_div" style="float: left;">@L.标题</div>
            </div>
        </div>
        <div style="clear: both;"></div>
        <div id="itemlist"></div>
        <a onclick="addItem();" class="appmsg_add" id="js_add_appmsg" href="javascript:void(0);" title="增加一个">
            <i class="zi zi_plus icon20"></i>
        </a>
    </div>
    <div class="col-12 col-md-9 table-responsive-md">
        <table class="table table-bordered table-striped">
            <tr class="td_m">
                <td class="wxtextl"><i class="zi zi_diamond"></i>@L.标题</td>
                <td>
                    <input type="text" ID="title_t" name="title_t" class="form-control text_300" onkeyup="UpdateTitle(this);" /></td>
            </tr>
            <tr>
                <td class="wxtextl"><i class="zi zi_image"></i>@L.图片</td>
                <td>
                    <input type="text" ID="picurl_t" name="picurl_t" class="form-control text_300" placeholder="@L.请输入本站在线图片地址"/>
                    <input type="button" value="@L.上传图片" class="btn btn-outline-info" onclick="SelectUppic({});" />
                    @*<input type="button" value="选择内容" class="btn btn-outline-info" onclick="SelContent()" />*@
                </td>
            </tr>
            <tr>
                <td class="wxtextl"><i class="zi zi_video"></i>@L.视频</td>
                <td>
                    <input type="text" ID="Video_T" name="Video_T" class="form-control text_300" placeholder="@L.请输入本站在线视频地址"/>
                    @*<input type="button" value="选择视频" class="btn btn-outline-info" onclick="SelVedio()" />*@
                </td>
            </tr>
            <tr>
                <td class="wxtextl"><i class="zi zi_link"></i>@L.链接</td>
                <td><input type="text" ID="url_t" name="url_t" class="form-control m715-50" /><span class="wtinfo">(@L.选填)</span></td>
            </tr>
            <tr>
                <td class="wxtextl"><i class="zi zi_alignleft"></i>@L.正文</td>
                <td>
                    <textarea ID="content_t" name="content_t" style="width: 800px; height: 300px;"></textarea>
                    @Html.Raw(Call.GetUEditor("content_t",3))
                </td>
            </tr>
        </table>
    </div>
	</div>
	</div>
	<div class="fixed-bottom Conent_add_fix">
   @*   <button type="button" class="btn btn-outline-info" onclick="PreWxMsg()">预览效果</button>*@
        <input type="submit" ID="Save_Btn" class="btn btn-outline-info" value="@L.保存消息" onclick="return PreSave();" />
        <button type="button" class="btn btn-outline-info" onclick="backToList();">@L.返回列表</button>
@*      <button type="button" ID="SaveNew_B" Visible="false" class=btn btn-outline-info" Text="保存素材" OnClick="SaveNew_B_Click" OnClientClick="return PreSave();" />
        <button type="button" ID="Update_Btn" class="btn btn-outline-info" Visible="false" Text="保存素材" OnClientClick="return UpdateData()" OnClick="Update_Btn_Click" />*@
		</div>

    <div id="selvedio_div" style="display:none;">
         <table class="table table-bordered table-striped">
             <tr><td>@L.视频地址:</td><td><input type="text" id="videosrc_t" class="form-control text_md" /> <span>@L.只支持腾讯视频!</span></td></tr>
             <tr><td>@L.视频宽度:</td><td><input type="text" id="vediowidth_t" class="form-control text_md" value="100" /></td></tr>
             <tr><td>@L.视频高度:</td><td><input type="text" id="vedioheight_t" class="form-control text_md" value="100" /></td></tr>
             <tr><td colspan="2" class="text-center"><button type="button" class="btn btn-outline-info" onclick="SetVideoHtml()">@L.确定</button> <button type="button" onclick="CloseVideoDiag()" class="btn btn-outline-info">@L.取消</button></td></tr>
         </table>
    </div>
    <div id="seturl_div" style="display:none;">
        <table class="table table-bordered table-striped">
            <tr><td>@L.链接名称:</td><td><input type="text" id="linkname_t" class="form-control text_md" /></td></tr>
            <tr><td>@L.链接地址:</td><td><input type="text" id="linkurl_t" class="form-control text_md" /></td></tr>
             <tr><td colspan="2" class="text-center"><button type="button" class="btn btn-outline-info" onclick="SetUrlHtml()">@L.确定</button> <button type="button" onclick="urldiag.CloseModal();" class="btn btn-outline-info">@L.取消</button></td></tr>            
        </table>
        
    </div>
    <input type="hidden" ID="News_Hid" name="News_Hid" value="@Model.MsgContent" />
@*  <button type="button" ID="TestMPNews_Btn" Text="上传图文素材" OnClick="TestMPNews_Btn_Click" />*@
</form>
 }
@section script{ 
<script src="/JS/Controls/ZL_Array.js"></script>
<script src="/js/Controls/ZL_Webup.js"></script>
<script src="/js/Mobile/ResizeImg/lrz.js"></script>
<script>
    var picup = new fileup({ accept: "image", zip: { enable: true }, up_after: function (url) {$("#picurl_t").val(url);UpdateImg(); } });
    var diag = new ZL_Dialog();
    function ShowDiag(url, title) {
        diag.maxbtn = false;
        diag.title = title;
        diag.url = url;
        diag.reload = true;
        diag.ShowModal();
    }
    function SelectUppic(pval) {
        //ShowDiag("/Common/SelFiles?pval=" + JSON.stringify(pval), "选择在线图片");
        picup.sel();
    }
    function SelContent() {
        ShowComDiag("/Common/Dialog/SelContent", "@Html.Raw(L.选择内容)");
    }
    //获取选择的文章内容
    function GetContent(content,title) {
        UE.getEditor("content_t").setContent(content);
        $("#title_t").val(title);
        CloseDiag();
    }
    function PageCallBack(action, vals, pval) {
        var url = vals.split('|')[0];
        if (url == "") return;
        url = url;
        $("#picurl_t").val(url);
        UpdateImg();
        diag.CloseModal();
    }
    function backToList()
    {
        if (!confirm("@Html.Raw(L.确定要退出未保存)")) { return false; }
        else { location = "MsgTlp";}
    }
    //----------
    //id使用随机字符串,最大不超过十个(含主体)
    var itemTlp = '<div class="msgitem msgitemf" data-id="@@id"><div class="itemleft"><div class="title_div">标题</div>'
        + '<div class="msgopt"><a href="javascript:;" title="编辑" class="edit_a" onclick="editItem(this);"><i class="zi zi_pencilalt"></i></a>'
        + '<a href="javascript:;" title="删除" class="del_a" onclick="delItem(this);"><i class="zi zi_trashalt"></i></a></div>'
                + '</div><div class="itemright"><img class="itemimg" src="" onerror="shownopic(this);" /></div></div>';
    var dataArr = [];
    var curid = "default";//当前正在编辑的元素ID
    $(function () {
        InitNews(itemTlp);
    });
    //初始化图文数据
    function InitNews(itemTlp) {
        var value = $("#News_Hid").val();
        if (ZL_Regex.isEmpty(value)) { dataArr.push({ id: "default", title: "默认封面", description: "", picurl: "", url: "" }); return; }
        //-------------------------------
        $("#itemlist").html("");
        dataArr = JSON.parse(value);
        for (var i = 0; i < dataArr.length; i++) {
            var data = dataArr[i];
            data.id = GetRanPass(4);
            if (i == 0) {//主图文显示
                $("#topimg").attr('src', data.picurl);
                $(".msgthumb .title_div").text(data.title);
                $(".msgthumb").data('id', data.id);
                curid = data.id;
            } else {
                var tlp = itemTlp.replace("@@id", data.id);
                var $tlp = $("<div>" + tlp + "</div>");
                $tlp.find('.title_div').text(data.title);
                $tlp.find('.itemimg').attr('src', data.picurl);
                $("#itemlist").append($tlp.html());
            }
        }
        //var subnews = JSON.parse(JSON.parse(value).content);
        //for (var i = 0; i < subnews.length; i++) {
        //   // var data = { id: GetRanPass(4), title: subnews[i].title, description: subnews[i].content, picurl: subnews[i].thumb_media_id, url: subnews[i].content_source_url, index: i }
        //    var data = subnews[i];
        //    if (i == 0) {//主图文显示
        //        $(".msgthumb .headimg").attr('src', data.picurl);
        //        $(".msgthumb .title_div").text(data.title);
        //        $(".msgthumb").data('id', data.id);
        //        curid = data.id;
        //    } else {
        //        var tlp = itemTlp.replace("@@id", data.id);
        //        var $tlp = $("<div>" + tlp + "</div>");
        //        $tlp.find('.title_div').text(data.title);
        //        $tlp.find('.itemimg').attr('src', datat.picurl);
        //        $("#itemlist").append($tlp.html());
        //    }
        //    dataArr.push(data);
        //}
        ShowByData(GetCur(), true);
    }
    function UpdateImg() {
        var cur = GetCur();
        var $div = $("div[data-id=" + cur.id + "]");
        $div.find('img').attr('src', $('#picurl_t').val());
    }
    function getItemMod() { return { id: GetRanPass(4), title: "", description: "", picurl: "", url: "", index: 0 }; }
    function addItem() {
        if ($(".msgitemf").length > 9) { alert("@Html.Raw(L.最多只允许8条图文)"); return; }
        var data = getItemMod();
        data.index = GetCur().index + 1;
        var tlp = itemTlp.replace("@@id", data.id);
        dataArr.push(data);
        $("#itemlist").append(tlp);
    }
    function delItem(btn) {
        var item = $(btn).closest(".msgitemf");
        var id = item.data("id");
        item.remove();
        DelByID(id);
    }
    function editItem(btn) {
        SaveToData();//先保存现有数据
        var item = $(btn).closest(".msgitemf");
        curid = item.data("id");
        var data = GetCur();
        ShowByData(data);
    }
    function CloseDiag() {
        diag.CloseModal();
        CloseComDiag();
    }
    function GetByID(id) {
        return ArrCOM.GetByID(dataArr, id);
    }
    function DelByID(id) {
        ArrCOM.RemoveByID(dataArr,id);
    }
    function GetCur() {
        if (curid == "") { return null; }
        return GetByID(curid);
    }
    function ShowByData(data,isfirst) {
        if (!data || data == null || data == undefined) { data = getItemMod(); }
        $("#title_t").val(data.title);
        $("#content_t").val(data.description);
        $("#picurl_t").val(data.picurl);
        $("#url_t").val(data.url);
        if(!isfirst)
        UE.getEditor("content_t").setContent(data.description);
            
    }
    function SaveToData() {
        if (curid == "") { return; }
        var data = GetCur();
        data.title = $("#title_t").val();
        data.description = $("#Video_T").val() + UE.getEditor("content_t").getContent();
        data.picurl = $("#picurl_t").val();
        data.url = $("#url_t").val();
    }
    //实时更新标题
    function UpdateTitle(obj) {
        var data = GetCur();
        var $div = $("div[data-id=" + data.id + "]");
        $div.find(".title_div").text(obj.value);
    }
    //每个文章都必须有图文,标题和内容?
    function CheckVal() {
        for (var i = 0; i < dataArr.length; i++) {
            var data = dataArr[i];
            if (data.title == "" || data.description == "") { alert("@Html.Raw(L.标题或内容不能为空)"); return false; }
            if (data.picurl == "") { alert("@Html.Raw(L.图片地址不能为空) 图片(封面)地址不能为空!"); return false;}
        }
        return true;
    }
    function PreSave() {
        SaveToData();
        $("#News_Hid").val(JSON.stringify(dataArr));
        return CheckVal();
    }
    function UpdateData() {
        SaveToData();
        var news = JSON.parse($("#News_Hid").val());
        var data = GetCur();
        var subnews = JSON.parse(news.content);
        var subdata = subnews[data.index];
        subdata.title = data.title;
        subdata.thumb_media_id = data.picurl;
        subdata.content_source_url = data.url;
        subdata.content = data.description;
        news.content = JSON.stringify(subnews);
        news.index = data.index;
        $("#News_Hid").val(JSON.stringify(news));
        return CheckVal();
    }
    var videodiag = new ZL_Dialog();
    function SelVedio() {
        videodiag.title = "选择视频";
        videodiag.content = "selvedio_div";
        videodiag.width = "vediodiag";
        videodiag.ShowModal();
    }
    //插入视频标签
    function SetVideoHtml() {
        if (CheckVideoData()) {
            var videourl = 'http://<%=Request.Url.Authority %>' + $("#videosrc_t").val();
            //var udit = UE.getEditor("content_t");
            //var videohtml = "<img width='" + $("#vediowidth_t").val() + "' height='" + $("#vedioheight_t").val() + "' _url='" + videourl +  "' class='edui-upload-video  vjs-default-skin' src='/Plugins/Ueditor/themes/default/images/spacer.gif' style='background:url(/Plugins/Ueditor/themes/default/images/videologo.gif) no-repeat center center; border:1px solid gray;'>"
            //var videohtml = "<p><video src='" + videourl + "' width='" + $("#vediowidth_t").val() + "px' height='" + $("#vedioheight_t").val() + "px' ></video></p>";
            var param = videourl.substr(videourl.lastIndexOf('?') + 1, videourl.length - videourl.lastIndexOf('?'));
            if (videourl.lastIndexOf('?')<0) {
                alert("@Html.Raw(L.不支持该地址格式)!")
                return false;
            }
            var videohtml = "<iframe class='video_iframe' style='z-index:1; ' height='" + $("#vedioheight_t").val() + "' width='" + $("#vediowidth_t").val() + "' frameborder='0' src='http://v.qq.com/iframe/player.html?" + param + "&width=" + $("#vediowidth_t").val() + "&height=" + $("#vedioheight_t").val() + "&auto=0' allowfullscreen=''></iframe>";
            $("#Video_T").val(videohtml);
            //udit.setContent(videohtml, true);
            CloseVideoDiag();
        }
            
    }
    var urldiag = new ZL_Dialog();
    function SetUrl(){
        urldiag.title = "插入链接";
        urldiag.content = "seturl_div";
        urldiag.width = "vediodiag";
        urldiag.ShowModal();
    }
    //插入链接
    function SetUrlHtml() {
        var udit = UE.getEditor("content_t");
        var linkhtml = "<a href='" + $("#linkurl_t").val() + "' target='_blank'>" + $("#linkname_t").val() + "</a>";
        udit.setContent(linkhtml, true);
        urldiag.CloseModal();
    }
    function CloseVideoDiag() {
        videodiag.CloseModal();
    }
    function CheckVideoData() {
        if ($("#Video_DD option:checked").val() == "-1") {
            alert("@Html.Raw(L.您还没有上传视频)!!");
            return false;
        }
        if (!ZL_Regex.isNum($("#vediowidth_t").val()) || !ZL_Regex.isNum($("#vedioheight_t").val())) {
            alert("@Html.Raw(L.视频宽度与高度必须为数字)!");
            return false;
        }
        return true;
    }
    function PreWxMsg() {
     //var media = "<%:MediaID%>";
     //   if (ZL_Regex.isEmpty(media)) { alert("必须先保存再预览"); return false; }
     //   SaveToData();
     //   ShowComDiag("PreWxMsg?appid=<%:AppID%>&MediaID=<%:MediaID%>", "预览图文");
    }
    function PreCheckSend() {
        CloseDiag();
        $("#Save_Btn").click();
    }
</script>
}