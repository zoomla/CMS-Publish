
@using System.Data
@using ZoomLa.BLL
@using ZoomLa.Model
@using ZoomLa.BLL.Plat
@using ZoomLa.Model.Plat
@using ZoomLa.SQLDAL
@using System.Data.SqlClient
@using ZoomLa.BLL.Helper
@using ZoomLa.BLL.User
@functions{
    private void GetNotify(M_User_Plat upMod)
    {
        //用户登录,检测有消息则提示
        B_Common_Notify comBll = new B_Common_Notify();
        DataTable dt = comBll.Blog_SelMy(upMod.UserID);
        foreach (DataRow dr in dt.Rows)//移除rows中的值,并添加已读列表
        {
            B_User_Notify.Add(dr["Title"].ToString(), dr["Content"].ToString(), upMod.UserID.ToString());
            string rece = StrHelper.IDS_Remove(dr["ReceUsers"].ToString(), upMod.UserID.ToString());
            string readed = StrHelper.IDS_AddTo(dr["ReadedUsers"].ToString(), upMod.UserID.ToString());
            List<SqlParameter> sp = new List<SqlParameter>() { new SqlParameter("rece", rece), new SqlParameter("readed", readed) };
            DBCenter.UpdateSQL("ZL_Common_Notify", "ReadedUsers=@readed,ReceUsers=@rece", "ID=" + dr["ID"], sp);
        }
    }
}
@{ 
    B_User_Plat upBll = new B_User_Plat();
    B_Plat_Comp cpBll = new B_Plat_Comp();
    M_User_Plat upMod = ViewBag.upMod;
    if (upMod == null) { upMod = upBll.SelReturnModel(new B_User(Context).GetLogin().UserID); }
    M_Plat_Comp compMod = cpBll.SelReturnModel(upMod.CompID);
    GetNotify(upMod);
}
<html>
<head>
@Html.Partial("_layout_assets")
<link href="/theme/css/V4user.css" rel="stylesheet" />
<style type="text/css">
/*部分页面与User共用,取消面包屑*/
.breadcrumb{display:none;}
.imgview { width: 100px; height: 100px; display: inline-block; }
.imgview .img { margin: auto auto auto 3px; width: 90px; height: 90px; }
.imgview .ext { display: block; margin: 20px auto auto; width: 50px; height: 50px; background: url(/images/User/files-icon-big.png) no-repeat; }
.imgview .doc, .imgview .docx { background-position: 0 0; }
.imgview .pdf { background-position: 0 -60px; }
.imgview .ppt { background-position: 0 -120px; }
.imgview .ps { background-position: 0 -180px; }
.imgview .rar { background-position: 0 -240px; }
.imgview .xls, .imgview .xlsx { background-position: 0 -360px; }
.imgview .zip { background-position: 0 -420px; }
.imgview .mp3 { background-position: 0 -480px; }
.imgview .mp4, .imgview .wmv { background-position: 0 -540px; }
.imgview .undefined { background-position: 0 -600px; }
.imgview .bmp, .imgview .gif, .imgview .jpg, .imgview .png { background-position: 0 -660px; }
.imgview .html { background-position: 0 -780px; }
.imgview .txt { background-position: 0 -840px; }
.imgview .flv { background-position: 0 -960px; }
.imgview .exe { background-position: 0 -1020px; }
.r_uinfo_div{width:610px;height:1000px;position:fixed;top:0px;right:0px;z-index:1001;border:1px solid #ddd;display:none;}
.r_uinfo_ifr{width: 100%; border: 0px; height: 1000px;}
.pull-left{float:left;}
</style>
@RenderSection("head", false)
<script src="/JS/Controls/ZL_Dialog.js"></script>
<script>
function setactive(content) {
var $li = null;
if (content && content != "") { $li = $("#topmenu_ul li:contains('" + content + "'):first"); }
if ($li && $li.length > 0) { $("#topmenu_ul li").removeClass("active"); $li.addClass("active"); }
}
function showword(obj) { shownoface(obj); }
</script>
</head>
<body class="Obody">
   
        <div class="navbar_bg"></div>
        <div class="newpane">
            <div class="newpanecontents">
                <nav class="navbar navbar-expand-lg navbar-dark bg-light top_mdnav">
                    <a class="navbar-brand ms-2" href="#">
                        <img src="@(compMod.CompLogo)" onerror="shownopic(this);" style="width:50px;height:50px;"/>
                        <span>@(compMod.CompShort+ "办公平台")</span>
                    </a>
                    </a>
                    <button class="navbar-toggler top_navisbtn" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample05" aria-controls="navbarsExample05" aria-expanded="false" aria-label="Toggle navigation">
                        <i class="zi zi_bars" aria-hidden="true"></i>
                        <i class="zi zi_times btn_none" aria-hidden="true"></i>
                    </button>

                    <div class="collapse navbar-collapse" id="navbarsExample05">
                        <ul class="navbar-nav me-auto">
                            <li class="active"><a href="/Plat/Blog/">主线</a></li>
                            <li class="nav-item"><a href="/Plat/Blog/Spec">话题</a></li>
                            <li class="nav-item"><a href="/Plat/Note/Project">项目</a></li>
                            <li class="nav-item"><a href="/Plat/Daily/Index">日程</a></li>
                            <li class="nav-item"><a href="/Plat/Group/CompDetail">公司</a></li>
                            <li class="nav-item"><a href="/Plat/Project">看板</a></li>
                        </ul>
                    </div>
                </nav>

                <div class="Otop d-flex justify-content-between bd-highlight">
                    <div class="Otitle">
                        <a href="javascript:;" class="menu">
                            <img id="logo_img" src="@(compMod.CompLogo)" onerror="shownopic(this);" style="width:50px;height:50px;"/>
                        </a>
                        <a href="/plat/blog">
                            @(compMod.CompShort+ "办公平台")
                        </a>
                    </div>
                    <ul id="topmenu_ul" class="topmenu_ul d-flex justify-content-start">
                        <li class="topnav_li active"><a href="/Plat/Blog/">主线</a></li>
                        <li class="topnav_li"><a href="/Plat/Blog/Spec">话题</a></li>
                        <li class="topnav_li"><a href="/Plat/Project/">项目</a></li>
                        <li class="topnav_li"><a href="/Plat/Daily/DailyPlan">日程</a></li>
                        <li class="topnav_li"><a href="/Plat/Group/CompDetail">公司</a></li>
                        <li class="topnav_li">@Html.ActionLink("看板", "Board", "Project");</li>
                        <li class="topnav_li"><a href="/ERP">ERP</a></li>
                        <li class="topnav_li"><a href="/Office/Index/Default">OA</a></li>
                        <li class="skey_li">
                            <i class="zi zi_search r_gray" style="position: absolute; left: 8px;top:8px;"></i>
                            <input type="text" class="form-control" id="skey_t" placeholder="搜索,回车确认" style="padding-left: 30px;" />
                        </li>
                    </ul>
                    <div class="Otop_r hidden-md hidden-xs hidden-sm">
                        <ul class="btns_ul  d-flex justify-content-start">
                            <li><a href="javascript:;" onclick="topnav.toggle();" id="skey_toggle_a"><i class="zi zi_search"></i></a></li>
                            <li><a href="/Plat/Admin/Index"><i class="zi zi_cog"></i></a></li>
                            @*<li class="ps-2"><a href="/Plat/Email/"><i class="zi zi_envelope"></i> 邮件</a></li>*@
                            <li>
                                <div class="btn-group ms-1">
                                    <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" aria-expanded="false">
                                        <img class="uimg img_xs" src="@upMod.UserFace" id="Main_UserFace_Img" onerror="shownoface(this);" />
                                        <span>@upMod.UserName</span>
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li class="dropdown-item"><a href="/Plat/Common/UPCenter">个人信息</a></li>
                                        <li class="dropdown-item"><a href="/Plat/Common/Contact">通讯录</a></li>
                                        <li class="dropdown-item"><a href="/Plat/Mail/">站内信</a></li>
                                        <li class="dropdown-item"><a href="/Plat/Doc/">云盘</a></li>
                                        <li class="dropdown-item"><a href="/Plat/Task/">任务</a></li>
                                        <li class="dropdown-item"><a href="/User/User/Logout">退出登录</a></li>
                                    </ul>
                                </div>

                            </li>
                            <li><a href="http://www.z01.com/OAS/" target="_blank"><i class="zi zi_questioncircle" zico="问题圆标"></i></a></li>
                        </ul>
                    </div>
                </div>

                <div class="leftnav hidden-xs hidden-sm" id="leftnav">
                    <ul class="tabul d-flex justify-content-start">
                        <li onclick="leftnav.load(this,'news');" style="padding-bottom: 2px;"><i class="zi zi_bubbleSquare"></i></li>
                        <li title="部门成员" onclick="leftnav.load(this,'users');"><i class="zi zi_users" zico="用户组"></i></li>
                        <li title="公司文档" onclick="leftnav.load(this,'doc');"><i class="zi zi_folders" zico="文件夹"></i></li>
                        <li title="会员应用" onclick="leftnav.load(this,'app');"><i class="zi zi_thlarge" zico="大号表头"></i></li>
                    </ul>
                    <div id="left_body" class="left_body" style="overflow-y: auto;"></div>
                    <div class="left_qrcode">
                        <img src="@(ZoomLa.Components.SiteConfig.SiteInfo.BannerUrl)" onerror="this.src='/UploadFiles/nopic.svg';" />
                        <div class="alert alert-success mt-2 text-center" role="alert"><span class="zi zi_circleUpBold" zico="指上圆箭头"></span>官方应用客户端</div>
                    </div>
                    <div class="left_footer">
                        <span class="foot_btn" onclick="location='/Plat/Doc/';" title="分享文件">
                            <i class="zi zi_plus zi_2x"></i>
                        </span>
                    </div>
                    <div class="leftnavbtn hidden-xs hidden-sm" onclick="leftnav.toggle(this);">
                        <i class="zi zi_circlelefts" style="font-size:1.5rem;"></i>
                    </div>
                </div>
                @RenderSection("content",false)
            </div>
        </div>
        <div id="scroll_div" class="scroll_div">
            <div class="scroll_top"><i class="zi zi_forUp" zico="上指"></i></div>
            <div class="scroll_botton"><i class="zi zi_forDown" zico="下指"></i></div>
            <div class="scroll_top_div scroll_desc">回到顶部</div>
            <div class="scroll_bottom_div scroll_desc">回到底部</div>
        </div>
        <div id="bubble_div" class="hidden-xs hidden-sm">
            <div class="msgnum" id="msgnum" title="查看主线">0</div>
            <i class="zi zi_bulbLine zi_2x" ></i>
        </div>
        <script src="/JS/DesktopNotify.js"></script>
        <script src="/JS/Controls/Control.js"></script>
       @RenderSection("script",false)
<script>
        var mconf = { date: "@(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"))" };
        $(function () {
            DesktopNotify.requestPermission(function () { });//后期改为个人配置
            if (window.screen.width < 768) {
                $(".scroll_div").addClass("hidden");
                $(".scroll_div").removeAttr("title");
            }
            topnav.init();
            leftnav.init();
            bubble.init();
        });
        //返回顶部与底部(是否与bubble结合)
        $(window.document).scroll(function () {
            if ($(window.document).scrollTop() > 5) { $(".scroll_div").fadeIn(400); }
            else { $(".scroll_div").fadeOut(400); }
        });
        $(".scroll_botton").mouseover(function () { $(".scroll_bottom_div").css("z-index", "99") });
        $(".scroll_top").mouseover(function () { $(".scroll_top_div").css("z-index", "99") });
        $(".scroll_desc").mouseout(function () { $(".scroll_desc").css("z-index", "-10"); });
        $(".scroll_div .scroll_bottom_div").click(function () { Control.Scroll.ToBottom(); });
        $(".scroll_div .scroll_top_div").click(function () { Control.Scroll.ToTop(); });
        //-------------左边栏(默认显示)
        var leftnav = { $body: $(".leftnav:first"), enabled: true };
        leftnav.init = function () {
            if (leftnav.enabled == false) { leftnav.$body.hide(); return; }
            //检测缓存中是否有值,无则默认打开
            var status = localStorage.getItem("leftnav");
            switch (status) {
                case "close":
                    leftnav.close();
                    break;
                case "open":
                default:
                    leftnav.open();
                    break;
            }
            var height = leftnav.$body.height() - 30 - 230 - 60;//减去头部与尾部
            setTimeout(function () { $(".leftnav").show(); }, 500);
            leftnav.$body.find(".tabul li:first").click();
            leftnav.$body.find("#left_body").height(height);
        }
        //zi zi_circlelefts zi_2x
        leftnav.toggle = function () {
            var $btn = $(".leftnavbtn");
            if ($btn.attr("title") == "开启") { leftnav.open(); }
            else { leftnav.close(); }
        }
        leftnav.close = function () {
            var $btn = $(".leftnavbtn");
            var $left = $(".leftnav");
            $left.animate({ "left": "-260" });
            $btn.attr("title", "开启").find(".zi").removeClass("zi_circlelefts").addClass("zi_circleRights");
            localStorage.setItem("leftnav", "close");
        }
        leftnav.open = function () {
            var $btn = $(".leftnavbtn");
            var $left = $(".leftnav");
            $left.animate({ "left": "0" })
            $btn.attr("title", "关闭").find(".zi").removeClass("zi_circleRights").addClass("zi_circlelefts");
            localStorage.setItem("leftnav", "open");

        }
        leftnav.load = function (li, name) {
            var url = "/Plat/Left/" + name + "";
            var wait = '<div class="text-center" style="padding-top:20px;color:#03a9f4;"><i class="zi zi_circlenotch zi_spin zi_3x"></i></div>';
            var $body = $("#left_body");
            $(li).addClass("active").siblings().removeClass("active");
            $body.html("").html(wait);
            $body.load(url, {}, function (html) { });
        }
        leftnav.gp = {};
        leftnav.gp.toggle = function (li) {
            var $li = $(li);
            var $btn = $li.find(".gp_btn");
            var $child = $li.siblings(".gp_child");
            if ($li.hasClass("open")) {
                //打开状态则关闭,单击要关联何种逻辑
                $li.removeClass("open");
                $btn.removeClass("fa-chevron-down").addClass("fa-chevron-right");
                $child.slideUp("fast");
            }
            else {
                $li.addClass("open");
                $btn.removeClass("fa-chevron-right").addClass("fa-chevron-down");
                $child.slideDown("fast");
            }
        }
        leftnav.preview = function (guid) {
            CloseComDiag();
            comdiag.maxbtn = false;
            comdiag.ShowModal("/PreView/Index?File=" + guid, "文件预览 <a href='DownFile?File=" + guid + "'>下载</a>");
        }
        leftnav.showuinfo = function (uid) {
            CloseComDiag();
            comdiag.maxbtn = false;
            //comdiag.ShowModal("../Views/Common/uinfo?uid=" + uid, "用户信息");
            comdiag.ShowModal("/Plat/Common/uinfo?uid="+uid, "用户信息");
            
        }
        leftnav.showmsg = function (id) {
            CloseComDiag();
            comdiag.maxbtn = false;
            comdiag.ShowModal("/Plat/Blog/Item?mode=diag&id=" + id, "信息浏览");
        }
        //-------------顶部条
        var topnav = {};
        //动画效果显示搜索条
        topnav.toggle = function () {
            var icon = $("#skey_toggle_a").find(".zi");
            if (icon.hasClass("zi_search")) {
                icon.removeClass("zi_search").addClass("zi_times");
                $(".topnav_li").fadeOut("fast", function () { $(".skey_li").fadeIn("fast"); })
            }
            else {
                icon.removeClass("zi_times").addClass("zi_search");
                $(".skey_li").fadeOut("fast", function () { $(".topnav_li").fadeIn("fast") });
            }
        }
        topnav.init = function () {
            var skey = "@Context.Request.GetParam("skey")";
if (skey) { $("#skey_t").val(unescape(skey)); }
if (!ZL_Regex.isEmpty(skey)) { topnav.toggle(); }
$("#skey_t").keydown(function () { if (event.keyCode == 13) { topnav.search(); return false; } });
}
topnav.search = function () {
var skey = $("#skey_t").val();
if (ZL_Regex.isEmpty(skey)) { return; }
else { location = "/Plat/Blog/Default?skey=" + escape(skey); }
}
//-------------
var bubble = {
    conf: {
        $audio: $('<video autoplay="autoplay" style="display:none;"></video>'),
        $body: $("#bubble_div"),
        $num: $("#bubble_div .msgnum"),
        worker: [],//计时器集合
    },
    //需要展示的信息
    info: { icon: "", cuname: "", title: "", content: "", click: null },
    init: function () {
        var ref = this;
        ref.conf.$num.click(function () { location = "/Plat/Blog/Default"; });
        ref.conf.$body.popover({
            placement: 'left', html: true,
            title: function () {
                return '<div style="min-width:210px;">' + ref.info.title + ' <a class="bubble_pop_close" onclick="$(\'#bubble_div\').popover(\'hide\');" title="关闭提示"><i class="zi zi_times"></i></a></div>';
            },
            content: function () { return '<div style="padding:5px;">' + bubble.info.content + '</div>'; }, trigger: "manual"
        });
        ref.work_at();
        ref.work_msg();
    },
    //提供信息提示
    say: function () {
        var ref = this;
        ref.play();
        ref.conf.$body.popover("show");
    },
    //桌面提示IE下使用say,webkit且有授权,使用通知模块
    //bubble.notify("/images/User/at.png","有人@你了","这是@的内容");
    notify: function (info) {
        var ref = this;
        if (DesktopNotify.isSupported && DesktopNotify.permissionLevel() == DesktopNotify.PERMISSION_GRANTED) {
            DesktopNotify.createNotification(info.title, {
                icon: info.icon,
                body: info.content,
                tag: "notice1",
                onClick: info.click
            });
        }
    },
    //播放提示音
    play: function () {
        var ref = this;
        ref.conf.$audio.attr("src", "/common/chat/msg.mp3");
        ref.conf.$audio[0].play();
    },
    //未读消息数
    setnum: function (num) {
        var ref = this;
        num = ConverToInt(num, 0);
        ref.conf.$num.text(num);
    },
    //检测at信息
    work_at: function () {
        var ref = this;
        ref.conf.worker["at"] = setInterval(function () {
            $.post("/Plat/Common/Common", { action: "getnotify" }, function (data) {
                var model = APIResult.getModel(data);
                if (APIResult.isok(model) && model.result.length > 0) {
                    var msg = model.result[0];
                    ref.info.icon = "/images/User/at.png";
                    ref.info.title = msg.title;
                    ref.info.content = msg.content;
                    ref.info.click = function () { location = "/Plat/Blog/Default?filter=atuser"; }
                    ref.say();
                    ref.notify(ref.info);
                }
            });
        }, 10000);
    },
    //有新的信息检测
    work_msg: function () {
        var ref = this;
        ref.conf.worker["msg"] = setInterval(function () {
            $.post("/Plat/Common/Common", { action: "newblog", date: mconf.date }, function (data) {
                ref.setnum(data);
            })
        }, 10000);
    }
};
//---------------------手机下右侧导航菜单效果
$(function () {
    $('button.navbar-toggle').click(function () {
        $('body').toggleClass('out');
        $('nav.navbar-fixed-top').toggleClass('out');
        if ($('body').hasClass('out')) {
            $(this).focus();
        }
        else {
            $(this).blur();
        }
    });
});

$(document).click(function (e) {
    if (!$(e.target).closest('.navbar-collapse, button.navbar-toggle').length && $('body').hasClass('out')) {
        e.preventDefault();
        $('button.navbar-toggle').trigger('click');
    }
}).keyup(function (e) {
    if (e.keyCode == 27 && $('body').hasClass('out')) {
        $('button.navbar-toggle').trigger('click');
    }
});
</script>
        <div class="notify_div" id="notify_div"></div>
        <script src="/JS/Controls/ZL_Array.js"></script>
        <script>
            //var notifyHtml = "<div class=\"notify_left\"><i class=\"zi zi_bell zi_5x\" style=\"color:#337ab7;\"></i></div>"
            //    + "<div class=\"notify_right\">"
            //    + "<div id=\"notify_title\" class=\"notify_title\"><i class='zi zi_exclamationCircle'></i> @@Title</a>"
            //    + "<a href='javascript:;' title='关闭' class='btn btn-outline-info'><i class='zi zi_times' onclick=\"$('#notify_div').hide();\"></i></a>"
            //    + "</div>"
            //    + "<div id=\"notify_body\">@@Content</div>"
            //    + "</div>"
            //    + "<div class=\"clearfix\"></div>";
            //function showNotify(data) {
            //    var model = APIResult.getModel(data);
            //    if (APIResult.isok(model)) {
            //        if (model.result.length < 1) { return; }
            //        console.log(model.result);
            //        $div = $("#notify_div"); $div.html("");
            //        var $items = JsonHelper.FillItem(notifyHtml, model.result);
            //        $div.append($items);
            //        $div.show();
            //    }
            //}

            //var nfy = new Notify();
            //nfy.Init({ url: "/common/api/notify.ashx?action=list&type=follow", interval: 3000, deskNotify: true, callback: showNotify });
            //nfy.GetNotify();

			//导航移动端切换
			//var b = true;
			//$("[data-target='#navbarsExample05']").click(function(){
			//if(b){
			//$(".Obody").addClass("out");
			//$("#navbarsExample05").css("right","0");
			//$(".btn_none").removeClass("btn_none").siblings().addClass("btn_none");
			//b=false;
			//}else{
			//$(".Obody").removeClass("out");
			//$("#navbarsExample05").css("right","-200px");
			//$(".btn_none").removeClass("btn_none").siblings().addClass("btn_none");
			//b=true;
			//}
			//})

        </script>
   
</body>
</html>
