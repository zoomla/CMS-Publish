@functions{
    //B_Blog_Sdl sdlBll = new B_Blog_Sdl();
    //   M_Blog_Sdl sdlMod = new M_Blog_Sdl();
    //   B_MisInfo typebll = new B_MisInfo();
    //   B_User buser = new B_User();
    //   public int UserID
    //   {
    //       get { return ViewState["userid"] == null ? DataConverter.CLng(Request.QueryString["userid"]) : DataConverter.CLng(ViewState["userid"]); }
    //       set { ViewState["userid"] = value; }
    //   }
    //   public int TypeID
    //   {
    //       get
    //       {
    //           if (ViewState["type"] == null)
    //           {
    //               ViewState["type"] = DataConvert.CLng(Request.QueryString["type"]);
    //           }
    //           return DataConvert.CLng(ViewState["type"]);
    //       }
    //       set { ViewState["type"] = value; }
    //   }
    //   public DateTime curDate
    //   {
    //       get { return ViewState["curDate"] == null ? DateTime.Now : DateTime.Parse(ViewState["curDate"].ToString()); }
    //       set { ViewState["curDate"] = value; }
    //   }
    //   string datatlp = "<tr><td class='text-center'>@index</td>@weekdata</tr>";//周视图
    //   protected void Page_Load(object sender, EventArgs e)
    //   {
    //       if (!IsPostBack)
    //       {
    //           if (UserID <= 0)
    //               UserID = buser.GetLogin().UserID;
    //           M_UserInfo mu = buser.SelReturnModel(UserID);
    //           if (mu.IsNull || mu.UserID < 1) { function.WriteErrMsg("选定的用户不存在"); }
    //           title_str.InnerText = mu.UserName + "的日程";
    //           UserName_Li.Text = mu.UserName;
    //           MyBind();
    //       }
    //   }
    //   public void MyBind()
    //   {
    //       //日程列表
    //       DataTable dt = typebll.SelByUid(UserID);
    //       M_MisInfo typeMod = null;
    //       if (dt.Rows.Count < 1)
    //       {
    //           typeMod = new M_MisInfo() { Title = "默认日程", MID = UserID, };
    //           typeMod.ID = typebll.insert(typeMod);
    //           dt = typebll.SelByUid(UserID);
    //           TypeID = typeMod.ID;
    //       }
    //       if (TypeID == 0)
    //       {
    //           TypeID = typebll.SelFirstModel(UserID).ID;
    //       }
    //       if (TypeID > 0)
    //       {
    //           typeMod = typebll.SelReturnModel(TypeID);
    //           if (typeMod == null)
    //               function.WriteErrMsg("该类别日程不存在!");
    //           TopSubName_Li.Text = "<span style='color:#999'>" + typeMod.Title + "</span>的";
    //       }
    //       else
    //       { TopSubName_Li.Text = "所有"; }
    //       SubList_RPT.DataSource = dt;
    //       SubList_RPT.DataBind();

    //       if (dt.Rows.Count == 0)
    //           EmptySub_Div.Visible = true;
    //       else
    //           EmptySub_Div.Visible = false;

    //       dt = sdlBll.SelByWeek(curDate, UserID, TypeID);
    //       InitWeek(dt);
    //       //抽出最近日程
    //       dt = sdlBll.SelTopSubject(UserID, TypeID);
    //       MyTop_RPT.DataSource = dt;
    //       MyTop_RPT.DataBind();
    //       if (dt.Rows.Count == 0)
    //           listempty_div.Visible = true;
    //       else
    //           listempty_div.Visible = false;

    //   }
    //   //初始化周视图
    //   public void InitWeek(DataTable dt)
    //   {
    //       int curweek = Convert.ToInt32(curDate.DayOfWeek);
    //       DateTime startDate = curDate.AddDays(-curweek + 1);
    //       DateTime endDate = curDate.AddDays(7 - curweek);
    //       DateSpan_L.Text = GetWeekTip();
    //       string datahtml = "";
    //       //输出日历标题
    //       for (int i = 0; i < 7; i++)
    //       {
    //           DateTime tempdate = curDate.AddDays((-curweek + 1 + i));
    //           Literal titleli = DateTitle.FindControl("TitleWeek_Li_D" + (i + 1)) as Literal;
    //           titleli.Text = tempdate.ToString("MM月dd日");
    //       }
    //       for (int i = 0; i < 24; i++)//小时循环
    //       {
    //           string daysstr = "";//每天数据模板
    //           for (int j = 0; j < 7; j++)
    //           {
    //               DateTime tempdate = curDate.AddDays((-curweek + 1 + j));
    //               daysstr += "<td class='datas' data-date='" + tempdate.ToString("yyyy-MM-dd") + "' data-hour='@hour'>" + GetContent(tempdate.Date.AddHours(i), dt) + "</td>";
    //           }
    //           datahtml += datatlp.Replace("@index", i.ToString()).Replace("@weekdata", daysstr).Replace("@hour", i.ToString());
    //       }
    //       WeekData_Li.Text = datahtml;
    //   }
    //   public string GetContent(DateTime date, DataTable dt)
    //   {
    //       dt.DefaultView.RowFilter = "StartDate<='" + date.AddMinutes(59).AddSeconds(59) + "' AND EndDate>='" + date + "'";//筛选符合时间条件的数据
    //       DataTable daysdata = dt.DefaultView.ToTable();
    //       if (daysdata.Rows.Count > 0)
    //       {
    //           //自适应计算
    //           string contenttlp = "<div class='content' data-id='@id' onclick='ViewDetail(this,@id)' style='width:" + (100 / daysdata.Rows.Count) + "%'>@name</div>";
    //           string html = "";
    //           foreach (DataRow item in daysdata.Rows)
    //           {
    //               string Name = item["Name"].ToString();
    //               html += contenttlp.Replace("@name", Name).Replace("@id", item["ID"].ToString());
    //           }
    //           return html;
    //       }
    //       return "";
    //   }
    //   public string GetWeekTip()
    //   {
    //       int curweek = Convert.ToInt32(curDate.DayOfWeek);
    //       DateTime startDate = curDate.AddDays(-curweek + 1);
    //       DateTime endDate = curDate.AddDays(7 - curweek);
    //       if (curDate.Date == DateTime.Now.Date.AddDays(-7))
    //           return "上周";
    //       if (curDate.Date == DateTime.Now.Date)
    //           return "本周";
    //       if (curDate.Date == DateTime.Now.Date.AddDays(7))
    //           return "下周";
    //       return startDate.ToString("yyyy年MM月dd日") + "-" + endDate.ToString("yyyy年MM月dd日");
    //   }

    //   //获取课程名
    //   public string GetSubName()
    //   {
    //       return Eval("Title").ToString();
    //   }
    //   protected void PreWeek_Btn_Click(object sender, EventArgs e)
    //   {
    //       curDate = curDate.AddDays(-7);
    //       MyBind();
    //   }
    //   protected void NextWeek_Btn_Click(object sender, EventArgs e)
    //   {
    //       curDate = curDate.AddDays(7);
    //       MyBind();
    //   }
    //   protected void BtnAdd_Click(object sender, EventArgs e)
    //   {
    //       sdlMod.Name = string.IsNullOrEmpty(Name_T.Text) ? "无标题" : Name_T.Text;
    //       sdlMod.TaskType = TypeID;
    //       sdlMod.StartDate = DataConverter.CDate(StartDate_Hid.Value.Trim());
    //       sdlMod.EndDate = DataConverter.CDate(EndDate_Hid.Value.Trim());
    //       if (sdlMod.StartDate > sdlMod.EndDate)
    //           function.WriteErrMsg("开始日期不能大于结束日期!");
    //       sdlMod.Describe = Request.Form["describe"].ToString();
    //       sdlMod.UserID = UserID;
    //       sdlBll.Insert(sdlMod);
    //       MyBind();
    //   }
    //   protected void AddType_B_Click(object sender, EventArgs e)
    //   {
    //       int typeid = DataConvert.CLng(TypeID_Hid.Value);
    //       M_MisInfo typeMod = typeid > 0 ? typebll.SelReturnModel(typeid) : new M_MisInfo();
    //       typeMod.Title = Type_T.Text;
    //       typeMod.MID = UserID;
    //       Type_T.Text = "";
    //       if (typeid > 0)
    //           typebll.UpdateByID(typeMod);
    //       else
    //           typebll.insert(typeMod);
    //       MyBind();
    //   }
    //   protected void SubList_RPT_ItemCommand(object source, RepeaterCommandEventArgs e)
    //   {
    //       switch (e.CommandName)
    //       {
    //           case "DelType":
    //               typebll.Del(DataConvert.CLng(e.CommandArgument));
    //               sdlBll.DelByType(UserID, TypeID);
    //               Response.Redirect("SubjectForWeek.aspx");
    //               break;
    //           default:
    //               break;
    //       }
    //   }

}
@section head{ 
<title runat="server" id="title_str">日程表</title>
<link type="text/css" rel="stylesheet" href="/JS/Plugs/date/bootstrap-datetimepicker.css" />
<script type="text/javascript" src="/JS/Plugs/date/bootstrap-datetimepicker.js"></script>
}
@section content{ 
    <nav class="navbar navbar-default ">
      <!-- We use the fluid option here to avoid overriding the fixed width of a normal container within the narrow content columns. -->
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-bs-toggle="collapse" data-bs-target="#bs-example-navbar-collapse-7" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand nav_title" href="/home"><span class="zi zi_home"></span> </a><a class="navbar-brand" href="/home"><asp:Literal runat="server" id="UserName_Li"></asp:Literal>的日程</a>
        </div>

        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-7">
          <ul class="nav navbar-nav dailyplan_nav">
            <li><a href="DailyPlan.aspx<%=Request.Url.Query %>"><span class="zi zi_calendar"></span> 月</a></li>
            <li class="active"><a href="SubjectForWeek.aspx<%=Request.Url.Query %>"><span class="zi zi_squarePlus"></span> 周</a></li>
            <li><a href="SubjectForDay.aspx<%=Request.Url.Query %>"><span class="zi zi_squareHandCorrect"></span> 日</a></li>
          </ul>
            <ul class="nav navbar-nav pull-right dailyplan_nav">
            <li><a href="/home"><span class="zi zi_spinner zi_pulse float-start"></span> <span class="loginout_str">能力中心</span></a></li>
            <li><a href="/User/" title="会员中心"><span class="loginout_str">会员中心</span></a></li>
            <li><a class="login_out" href="/User/User/Logout?url=/BU/ke/DailyPlan.aspx"><span class="loginout_str">退出</span></a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container-fluid">
        <div class="col-md-2">
            <div class="panel panel-default">
            <div class="panel-heading">日程列表[<a href="SubjectForWeek.aspx?type=-1">所有日程</a>]<span class="pull-right"><a href="javascript:;" title="添加日程" onclick="ShowTypeDiag()"><span class="zi zi_plus"></span></a></span></div>
              <ul class="list-group ullist" id="sublist">
                <asp:Repeater ID="SubList_RPT" runat="server" OnItemCommand="SubList_RPT_ItemCommand">
                    <ItemTemplate>
                        <li class="list-group-item" data-uid="<%#Eval("MID") %>" data-type="<%#Eval("ID") %>"><%#GetSubName() %>
                            <span class="pull-right">
                                <a href="javascript:;" title="修改" onclick="event.stopPropagation();ShowEditType(<%#Eval("ID") %>,'<%#Eval("Title") %>')"><span class="zi zi_pencilalt"></span></a>
                                <asp:LinkButton runat="server" CommandName="DelType" OnClientClick="event.stopPropagation(); return confirm('确认删除该日程吗?')" CommandArgument='<%#Eval("ID") %>'><span class="zi zi_trashalt"></span></asp:LinkButton>
                            </span>
                        </li>
                    </ItemTemplate>
                </asp:Repeater>
              </ul>
                <div class="panel-body empty_div" runat="server" visible="false" id="EmptySub_Div">
                    <p>没有相关日程!</p>
                </div>
            </div>
        </div>
        <div class="col-md-7">
        <table class="table table-bordered" id="DateTable">
            <thead id="DateTitle" runat="server">
                <tr>
                  <td colspan="8"><asp:LinkButton runat="server" CssClass="btn btn-primary" OnClick="PreWeek_Btn_Click" ToolTip="上一周"><i class="zi zi_circleLeftLong"></i></asp:LinkButton>
                    <strong style="font-size: 25px; position: relative; top: 4px;">
                    <asp:Label ID="DateSpan_L" runat="server"></asp:Label>
                    </strong>
                    <asp:LinkButton runat="server" CssClass="btn btn-primary" OnClick="NextWeek_Btn_Click" ToolTip="下一周"><i class="zi zi_circleRightLong"></i></asp:LinkButton></td>
                </tr>
                <tr>
                  <td></td>
                  <td><asp:Literal runat="server" ID="TitleWeek_Li_D1" EnableViewState="false"></asp:Literal>,周一</td>
                  <td><asp:Literal runat="server" ID="TitleWeek_Li_D2" EnableViewState="false"></asp:Literal>,周二</td>
                  <td><asp:Literal runat="server" ID="TitleWeek_Li_D3" EnableViewState="false"></asp:Literal>,周三</td>
                  <td><asp:Literal runat="server" ID="TitleWeek_Li_D4" EnableViewState="false"></asp:Literal>,周四</td>
                  <td><asp:Literal runat="server" ID="TitleWeek_Li_D5" EnableViewState="false"></asp:Literal>,周五</td>
                  <td><asp:Literal runat="server" ID="TitleWeek_Li_D6" EnableViewState="false"></asp:Literal>,周六</td>
                  <td><asp:Literal runat="server" ID="TitleWeek_Li_D7" EnableViewState="false"></asp:Literal>,周日</td>
                </tr>
            </thead>
            <tbody id="DateBody" class="datebody_item" runat="server">
               <asp:Literal ID="WeekData_Li" runat="server" EnableViewState="false"></asp:Literal>
            </tbody>
        </table>
        </div>
        <div class="col-md-3">
            <div class="panel panel-default">
            <div class="panel-heading"><asp:Literal ID="TopSubName_Li" runat="server"></asp:Literal>日程</div>
              <ul class="list-group ullist" id="lastlist">
                <asp:Repeater ID="MyTop_RPT" runat="server">
                    <ItemTemplate>
                        <li class="list-group-item" data-id="<%#Eval("ID") %>"><span class="last_title"><%#Eval("Name") %></span> <span class="pull-right last_date"><%#Eval("StartDate") %></span></li>
                    </ItemTemplate>
                </asp:Repeater>
              </ul>
                <div class="panel-body empty_div" runat="server" visible="false" id="listempty_div">
                    <p>您还没有日程!</p>
                </div>
            </div>
        </div>
    </div>
<div id="addsubject_div" style="display:none;">
    <table id="Add_Table" class="table">
      <tr>
        <td class="text-end td_m"><span><span style="color: red; margin-left: 1em;">*</span>日程名称:</span></td>
        <td><asp:TextBox runat="server" type="text" ID="Name_T" class="form-control text_300 day_text" ></asp:TextBox></td>
      </tr>
      <tr>
        <td class="text-end"><span><span style="color: red; margin-left: 1em; text-decoration: none;">*</span>时间:</span></td>
        <td><asp:TextBox class="form-control text_x day_text formdate" ID="txtBeginTime" runat="server"></asp:TextBox>
          -
          <asp:TextBox class="form-control text_x day_text formdate" ID="txtEndTime"  runat="server"></asp:TextBox> <span style="color:red;display:none;">结束时间不能早于开始时间!</span>
            <asp:HiddenField ID="StartDate_Hid" runat="server" />
            <asp:HiddenField ID="EndDate_Hid" runat="server" />
            <input type="hidden" value="" id="curdate_hid" />
          <asp:RequiredFieldValidator ID="Req1" ValidationGroup="Add" runat="server" ErrorMessage="开始或结束时间不能为空！" ControlToValidate="txtEndTime"></asp:RequiredFieldValidator></td>
      </tr>
    <%--  <tr>
        <td class="text-end"><span>负责人:</span></td>
        <td><input type="text" id="LeaderIDS_T" class="form-control text_300 day_text"/>
          <input type="button" value="选择" onclick="selRuser();" class="btn btn-primary" style="margin-left:5px;" />
          <asp:HiddenField runat="server" ID="LeaderIDS_Hid" /></td>
      </tr>
      <tr>
        <td class="text-end"><span>参与人:</span></td>
        <td><input type="text" id="PartTakeIDS_T" class="form-control text_300 day_text"  placeholder="选择用户名或姓名"/>
          <input type="button" value="选择" onclick="selCuser();" class="btn btn-primary" style="margin-left:5px;"/>
          <asp:HiddenField runat="server" ID="PartTakeIDS_Hid" /></td>
      </tr>--%>
      <tr>
        <td class="text-end"><span>日程描述:</span></td>
        <td><textarea class="form-control day_text" style=" height: 8em;" name="describe" placeholder="点击此处添加日程描述"></textarea></td>
      </tr>
      <tr>
        <td colspan="2" style="text-align:center;"><asp:Button ID="Add_Btn" runat="server" Text="提交" CssClass="btn btn-primary" OnClientClick="return SetData()" OnClick="BtnAdd_Click"  ValidationGroup="Add" />
            <input type="button" class="btn btn-default" onclick="ViewTaskDetail()"  data-bs-dismiss="modal"value="取消" />
        </td>
      </tr>
      <tr>
        <td></td>
        <td></td>
      </tr>
        <asp:HiddenField ID="TypeName_Hid" runat="server" />
    </table>
  </div>
     <div id="addtype_div" style="display:none;">
            <div class="input-group text_300">
            <asp:HiddenField ID="TypeID_Hid" runat="server" />
            <asp:TextBox ID="Type_T" CssClass="form-control" placeholder="日程名" Text="" runat="server"></asp:TextBox>
                <span class="input-group-btn"><asp:Button ID="AddType_B" runat="server" OnClick="AddType_B_Click" Text="确定" OnClientClick="return CheckTypeData()" CssClass="btn btn-primary" /></span>
            </div>
    </div>
    <div id="taskDetail_Div" style="height: 100%; width: 610px; position: fixed; bottom: 0px; right: 0px; border-left: 1px solid #ddd; background-color: white; display: none; z-index: 1031;" onfocus="console.log('11');" onblur="console.log('22');">
<iframe id="taskDetail_if" style=" border: none; height: 100%; width: 100%; overflow:hidden;"></iframe>
</div>

}
@section script{ 
        <script type="text/javascript" src="/JS/Controls/ZL_Dialog.js"></script>
    <script>
        var diag = new ZL_Dialog();
        var flag=0;
        $().ready(function () {
            $("#DateBody .datas").dblclick(function () {
                diag.title = "添加日程";
                diag.width = "adddiag";
                diag.content = "addsubject_div";
                diag.ShowModal();
                $(".day_text").val('');
                var date=$(this).data('date');
                $("#txtBeginTime").val($(this).data('hour') + ':00:00');
                $("#txtEndTime").val($(this).data('hour') + ':00:00');
                $("#txtEndTime").next().hide();
                $("#curdate_hid").val(date);
                $('[name=place]').val('<%=TypeID %>');
                if(flag==0){
                    //时间控件
                    $(".formdate").datetimepicker({
                        format:"hh:ii:ss",
                        language:"zh-CN",
                        startView:"day",
                        weekStart: 1,
                        minView:'hour',
                        maxView:'decade',
                        todayBtn:1,
                        autoclose: 1,
                        startDate:date
                    })
                    flag++;
                }
            });
            
            //提示工具
            $("#DateBody .datas").each(function (i, v) {
                $(v).tooltip({ title: $(v).data('hour')+':00', placement: 'left', container: 'body' });
            });
            $("#DateBody tr").hover(function () { $(this).find('td').first().addClass("td_active") }, function () { $(this).find('td').first().removeClass("td_active") });
            //最近日程点击事件
            $("#lastlist li").click(function () { ViewDetail(this,$(this).data('id')); });
            //日程列表
            var type='<%=TypeID %>',userid=<%=UserID %>;
            $("#sublist [data-uid='"+userid+"'][data-type='"+type+"']").addClass("sub_active");
            $("#sublist li").click(function(){
                window.location.href="SubjectForWeek.aspx?userid="+$(this).data('uid')+"&type="+$(this).data("type");
            });
        });
       
        //替换开始时间与结束时间格式
        function SetData() {
            if($("#Name_T").val()==""){
                alert('日程名称不能为空!');
                return false;
            }
            if ($("#txtBeginTime").val() == "" || $("#txtEndTime").val() == "") {
                alert('开始时间或结束时间不能为空!');
                return false;
            }
            if($("[name='place']").val()==""){
                alert("日程类别不能为空!")
                return false;
            }
            $("#StartDate_Hid").val($("#curdate_hid").val() + " " + $("#txtBeginTime").val());
            $("#EndDate_Hid").val($("#curdate_hid").val() + " " + $("#txtEndTime").val());
            if(Date.parse($("#StartDate_Hid").val().replace('-','/'))>Date.parse($("#EndDate_Hid").val().replace('-','/'))){
                $("#txtEndTime").next().show();
                return false;
            }
            $("#txtEndTime").next().hide();
            return true;
        }

        //修改操作
        function ViewDetail(obj,id) {
            $("#taskDetail_if").attr("src", "DailyDetail.aspx?ID=" + id);
            $("#taskDetail_Div").show();
            $(".con_active").removeClass('con_active');
            $(obj).addClass("con_active");
        }
        function HideMe() {
            $("#taskDetail_Div").fadeOut("fast");
        }
        function UpdateData(id,content){
            $(".content[data-id='"+id+"']").text(content);
            $("#lastlist [data-id='"+id+"'] .last_title").text(content);
            $("#taskDetail_Div").hide();
        }
        function DelData(id){
            $(".content[data-id='"+id+"']").remove();
            $("#lastlist [data-id='"+id+"']").remove();
            $("#taskDetail_Div").hide();
        }
        //添加日程类型
        var typediag=new ZL_Dialog();
        function ShowTypeDiag(){
            EmptyTypeDate();
            typediag.title="新建日程类型";
            typediag.content="addtype_div";
            typediag.width="typediag";
            typediag.ShowModal();
        }
        //修改日程类型
        function ShowEditType(id,title){
            EmptyTypeDate();
            typediag.title="修改日程类别";
            typediag.content="addtype_div";
            typediag.width="typediag";
            typediag.ShowModal();
            $("#Type_T").val(title);
            $("#TypeID_Hid").val(id);
            $("#AddType_B").val("修改");
            return false;
        }
        //清空编辑日程类型信息
        function EmptyTypeDate(){
            $("#Type_T").val('');
            $("#TypeID_Hid").val('');
            $("#AddType_B").val("添加");
        }
        function CheckTypeData(){
            if($("#Type_T").val()==""){
                alert("日程名称不能为空!");
                return false;
            }
            return true;
        }
    </script>
}
